const url = "https://www.virustotal.com/vtapi/v2/file"
const apikey = 'd696b69242cae6d76325eef42d0255e668dac5573dd823d031cce025e049faa6';

async function onScanVirus() {
    const fileScan = document.getElementById('fileScan');

    console.log("Click")
    // const encodedParams = new URLSearchParams();
    // encodedParams.set('apikey', 'd696b69242cae6d76325eef42d0255e668dac5573dd823d031cce025e049faa6');
    // encodedParams.set('file','');
    const formData = new FormData();
    formData.append('apikey', apikey);
    formData.append('file', fileScan.files[0]);
    // document.getElementById('progress').style.display = "block";
    // document.getElementById('progress').style.alignContent = "center";
    $('#progress').show()
    console.log(formData);
    const response = await fetch(`${url}/scan`, {
        method: 'POST',
        body: formData
    });

    if (response.status == 200) {
        document.getElementById('exampleModalLabel').innerHTML = "Scan Successful!"
        var img = document.getElementById('imgResult');
        var newImg = new Image();
        newImg.onload = function () {
            img.src = this.src
        }
        newImg.src = '../assets/img/success.png';
        const data = await response.json();
        fetchReportScan(data['resource'])
    } else {
        document.getElementById('exampleModalLabel').innerHTML = "Scan Failed!"
        var img = document.getElementById('imgResult');
        var newImg = new Image();
        newImg.onload = function () {
            img.src = this.src
        }
        newImg.src = '../assets/img/fail.png';
    }
    // document.getElementById('progress').style.display = "none";
    $('#progress').hide()
    $('#scanModal').modal('show');

    
    // console.log(data)
}

async function fetchReportScan(resource){
    const response = await fetch(`${url}/report?apikey=${apikey}&resource=${resource}&allinfo=false`)
    const data = await response.json();
    let result = "<div>";
    var isProtected = false;
    for(let x in data['scans']){
        if(data['scans'][x]['detected']){
            isProtected = data['scans'][x]['detected']
            var img = document.getElementById('imgResult');
            var newImg = new Image();
            newImg.onload = function () {
                img.src = this.src
            }
            newImg.src = '../assets/img/warning.png';
            result += x + ": " + data['scans'][x]['detected'] + "<br/>";
        }
    }
    result += "</div>";
    if(!isProtected){
        result = "<div>The file is Safe</div>";
    }
    $('#result').append(result)
    
    // document.getElementById('result').innerHTML = result
    // console.log(result)
}

function hideModal() {
    $('#scanModal').modal('hide');
}
